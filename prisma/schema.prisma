generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String        @id @default(cuid())
  clerkId             String        @unique
  email               String        @unique
  name                String?
  onboardingCompleted Boolean       @default(false)
  lastLoginAt         DateTime?
  emailOptOut         Boolean       @default(false)
  emailPreferences    Json?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  role                UserRole      @default(USER)
  resumes             Resume[]
  subscription        Subscription?
  payments            Payment[]
  emailJobs           EmailJob[]

  @@index([clerkId])
  @@index([email])
  @@index([name])
  @@index([emailOptOut])
  @@index([lastLoginAt])
}

model Resume {
  id           String          @id @default(cuid())
  userId       String
  title        String
  template     String          @default("modern")
  status       ResumeStatus    @default(DRAFT)
  isPublic     Boolean         @default(false)
  publicSlug   String?         @unique
  personalInfo Json?
  summary      String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  sections     ResumeSection[]

  @@index([userId])
  @@index([publicSlug])
  @@index([userId, updatedAt])
  @@index([status])
  @@index([template])
}

model ResumeSection {
  id        String      @id @default(cuid())
  resumeId  String
  type      SectionType
  title     String
  content   Json
  order     Int
  isVisible Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  resume    Resume      @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@unique([resumeId, order])
  @@index([resumeId])
  @@index([resumeId, type])
}

model Subscription {
  id            String             @id @default(cuid())
  userId        String             @unique
  plan          SubscriptionPlan   @default(FREE)
  status        SubscriptionStatus @default(ACTIVE)
  paymentMethod String?
  paymentId     String?
  startDate     DateTime           @default(now())
  endDate       DateTime?
  cancelledAt   DateTime?
  resumeCount   Int                @default(0)
  aiUsageCount  Int                @default(0)
  exportCount   Int                @default(0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  importCount   Int                @default(0)
  atsUsageCount Int                @default(0)
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([status, endDate])
}

model SystemSettings {
  id               Int      @id @default(autoincrement())
  maxFreeResumes   Int      @default(10)
  maxFreeAIUsage   Int      @default(100)
  maxFreeExports   Int      @default(20)
  maxFreeImports   Int      @default(1)
  maxFreeATSChecks Int      @default(0)
  maxProResumes    Int      @default(-1)
  maxProAIUsage    Int      @default(-1)
  maxProExports    Int      @default(-1)
  maxProImports    Int      @default(-1)
  maxProATSChecks  Int      @default(-1)
  proPlanPrice     Int      @default(5000)
  maintenanceMode  Boolean  @default(false)
  updatedAt        DateTime @default(now()) @updatedAt
  freeTemplates    Json     @default("[\"modern\"]")
  proTemplates     Json     @default("[\"modern\"]")
  photoUploadPlans Json     @default("[\"PRO\"]")
}

enum UserRole {
  USER
  ADMIN
}

enum ResumeStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SectionType {
  WORK_EXPERIENCE
  EDUCATION
  SKILLS
  LANGUAGES
  CERTIFICATIONS
  PROJECTS
  ACHIEVEMENTS
  REFERENCES
  CUSTOM
}

enum SubscriptionPlan {
  FREE
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  SUSPENDED
}

// Partial unique index on (userId) WHERE status='PENDING' is enforced via raw migration
// (see prisma/migrations/20260222_add_pending_payment_unique_index/migration.sql)
model Payment {
  id              String           @id @default(cuid())
  userId          String
  plan            SubscriptionPlan
  amount          Int
  screenshotData  Bytes
  screenshotType  String
  priceAtCreation Int?
  status          PaymentStatus    @default(PENDING)
  adminNote       String?
  createdAt       DateTime         @default(now())
  reviewedAt      DateTime?
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
  @@index([status])
  @@index([createdAt])
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  REFUNDED
}

model AdminAuditLog {
  id        String   @id @default(cuid())
  adminId   String
  action    String
  target    String
  details   Json?
  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([adminId, createdAt])
  @@index([createdAt])
}

model SettingsSnapshot {
  id        String   @id @default(cuid())
  data      Json
  savedBy   String
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model EmailJob {
  id          String         @id @default(cuid())
  userId      String
  campaign    EmailCampaign
  status      EmailJobStatus @default(PENDING)
  scheduledAt DateTime
  sentAt      DateTime?
  error       String?
  metadata    Json?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, campaign, status], name: "unique_pending_campaign")
  @@index([status, scheduledAt])
  @@index([userId])
  @@index([campaign])
  @@index([createdAt])
}

model EmailLog {
  id             String              @id @default(cuid())
  emailJobId     String?
  userId         String?
  campaign       EmailCampaign
  recipientEmail String
  subject        String
  status         EmailDeliveryStatus @default(QUEUED)
  error          String?
  sentAt         DateTime?
  deliveredAt    DateTime?
  openedAt       DateTime?
  createdAt      DateTime            @default(now())

  @@index([emailJobId])
  @@index([userId])
  @@index([campaign])
  @@index([status])
  @@index([createdAt])
}

enum EmailCampaign {
  WELCOME
  ABANDONED_RESUME
  RE_ENGAGEMENT
}

enum EmailJobStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  CANCELLED
}

enum EmailDeliveryStatus {
  QUEUED
  SENT
  DELIVERED
  OPENED
  FAILED
  BOUNCED
}
